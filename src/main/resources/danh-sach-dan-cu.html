<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>Quản Lý Dân Cư - Danh Sách</title>

    <!-- Thay thế link local bằng CDN -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" rel="stylesheet" type="text/css">
    <link href="https://fonts.googleapis.com/css?family=Nunito:200,200i,300,300i,400,400i,600,600i,700,700i,800,800i,900,900i" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/startbootstrap-sb-admin-2@4.1.4/css/sb-admin-2.min.css" rel="stylesheet">
    <link href="https://cdn.datatables.net/1.10.24/css/dataTables.bootstrap4.min.css" rel="stylesheet">
</head>

<body id="page-top">

    <div id="wrapper">

        <ul class="navbar-nav bg-gradient-primary sidebar sidebar-dark accordion" id="accordionSidebar">

            <a class="sidebar-brand d-flex align-items-center justify-content-center" href="index.html">
                <div class="sidebar-brand-icon rotate-n-15">
                    <i class="fas fa-building"></i>
                </div>
                <div class="sidebar-brand-text mx-3">BlueMoon</div>
            </a>

            <hr class="sidebar-divider my-0">

            <li class="nav-item">
                <a class="nav-link" href="index.html">
                    <i class="fas fa-fw fa-home"></i>
                    <span>Trang chủ</span>
                </a>
            </li>

            <li class="nav-item">
                <a class="nav-link" href="can-ho.html">
                    <i class="fas fa-fw fa-door-open"></i>
                    <span>Căn hộ</span>
                </a>
            </li>

            <li class="nav-item active">
                <a class="nav-link" href="danh-sach-dan-cu.html">
                    <i class="fas fa-fw fa-users"></i>
                    <span>Cư dân</span>
                </a>
            </li>

            <li class="nav-item">
                <a class="nav-link" href="khoan-thu.html">
                    <i class="fas fa-fw fa-file-invoice-dollar"></i>
                    <span>Khoản thu</span>
                </a>
            </li>

            <li class="nav-item">
                <a class="nav-link" href="thong-ke.html">
                    <i class="fas fa-fw fa-chart-bar"></i>
                    <span>Thống kê</span>
                </a>
            </li>

            <li class="nav-item">
                <a class="nav-link" href="thong-bao.html">
                    <i class="fas fa-fw fa-bullhorn"></i>
                    <span>Thông báo</span>
                </a>
            </li>

            <li class="nav-item">
                <a class="nav-link" href="phan-anh.html">
                    <i class="fas fa-fw fa-comments"></i>
                    <span>Phản ánh</span>
                </a>
            </li>

            <li class="nav-item">
                <a class="nav-link" href="tai-khoan.html">
                    <i class="fas fa-fw fa-user-cog"></i>
                    <span>Tài khoản</span>
                </a>
            </li>

            <hr class="sidebar-divider">

            <li class="nav-item">
                <a class="nav-link" href="cai-dat.html">
                    <i class="fas fa-fw fa-cog"></i>
                    <span>Cài đặt</span>
                </a>
            </li>

            <div class="text-center d-none d-md-inline">
                <button class="rounded-circle border-0" id="sidebarToggle"></button>
            </div>

        </ul>
        <div id="content-wrapper" class="d-flex flex-column">

            <div id="content">

                <nav class="navbar navbar-expand navbar-light bg-white topbar mb-4 static-top shadow">
                    <button id="sidebarToggleTop" class="btn btn-link d-md-none rounded-circle mr-3">
                        <i class="fa fa-bars"></i>
                    </button>

                    <ul class="navbar-nav ml-auto">
                        <div class="topbar-divider d-none d-sm-block"></div>
                        <li class="nav-item dropdown no-arrow">
                            <a class="nav-link dropdown-toggle" href="#" id="userDropdown" role="button"
                                data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                <span class="mr-2 d-none d-lg-inline text-gray-600 small">Admin Quản Lý</span>
                                <img class="img-profile rounded-circle" src="https://source.unsplash.com/QAB-WJcbgJk/60x60">
                            </a>
                            <div class="dropdown-menu dropdown-menu-right shadow animated--grow-in"
                                aria-labelledby="userDropdown">
                                <a class="dropdown-item" href="#">
                                    <i class="fas fa-user fa-sm fa-fw mr-2 text-gray-400"></i> Hồ sơ
                                </a>
                                <div class="dropdown-divider"></div>
                                <a class="dropdown-item" href="#" data-toggle="modal" data-target="#logoutModal">
                                    <i class="fas fa-sign-out-alt fa-sm fa-fw mr-2 text-gray-400"></i> Đăng xuất
                                </a>
                            </div>
                        </li>
                    </ul>
                </nav>

                <div class="container-fluid">

                    <h1 class="h3 mb-2 text-gray-800">Danh Sách Cư Dân</h1>
                    <p class="mb-4">Quản lý thông tin chi tiết cư dân, hộ khẩu và tình trạng cư trú.</p>
                    
                    <div class="card shadow mb-4">
                        <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                            <h6 class="m-0 font-weight-bold text-primary">Dữ liệu tổng hợp</h6>
                            <button type="button" class="d-none d-sm-inline-block btn btn-sm btn-primary shadow-sm" id="btnAddResident" data-toggle="modal" data-target="#residentModal">
                                <i class="fas fa-user-plus fa-sm text-white-50"></i> Thêm Cư dân
                            </button>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-bordered" id="dataTable" width="100%" cellspacing="0">
                                    <thead>
                                        <tr>
                                            <th>STT</th>
                                            <th>Mã hộ khẩu</th> <!-- Đã thêm cột này -->
                                            <th>Họ và Tên</th>
                                            <th>Căn hộ</th>
                                            <th>Quan hệ chủ hộ</th>
                                            <th>Số CCCD</th>
                                            <th>Loại cư trú</th>
                                            <th>Hành động</th>
                                        </tr>
                                    </thead>
                                    <tbody id="residentsTableBody">
                                        <tr><td colspan="8" class="text-center">Đang tải dữ liệu...</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
            
            <footer class="sticky-footer bg-white">
                <div class="container my-auto">
                    <div class="copyright text-center my-auto">
                        <span>Copyright &copy; BlueMoon 2025</span>
                    </div>
                </div>
            </footer>

        </div>
    </div>

    <a class="scroll-to-top rounded" href="#page-top">
        <i class="fas fa-angle-up"></i>
    </a>

    <!-- Resident Add/Edit Modal -->
    <div class="modal fade" id="residentModal" tabindex="-1" role="dialog" aria-labelledby="residentModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="residentModalLabel">Thêm Cư dân</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <form id="residentForm">
                    <div class="modal-body">
                        <input type="hidden" id="residentId" name="id">
                        
                        <div class="form-group">
                            <label for="residentMaHo">Mã hộ gia đình <span class="text-danger">*</span></label>
                            <select class="form-control" id="residentMaHo" name="maHo" required>
                                <option value="">-- Chọn hộ gia đình --</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="residentHoTen">Họ và tên <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="residentHoTen" name="hoTen" required>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="residentNgaySinh">Ngày sinh <span class="text-danger">*</span></label>
                                    <input type="date" class="form-control" id="residentNgaySinh" name="ngaySinh" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="residentGioiTinh">Giới tính <span class="text-danger">*</span></label>
                                    <select class="form-control" id="residentGioiTinh" name="gioiTinh" required>
                                        <option value="">-- Chọn --</option>
                                        <option value="Nam">Nam</option>
                                        <option value="Nữ">Nữ</option>
                                        <option value="Khác">Khác</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="residentSoCCCD">Số CCCD/CMND</label>
                            <input type="text" class="form-control" id="residentSoCCCD" name="soCCCD" maxlength="20">
                        </div>
                        
                        <div class="form-group">
                            <label for="residentNgheNghiep">Nghề nghiệp</label>
                            <input type="text" class="form-control" id="residentNgheNghiep" name="ngheNghiep" maxlength="100">
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="residentQuanHeChuHo">Quan hệ với chủ hộ <span class="text-danger">*</span></label>
                                    <select class="form-control" id="residentQuanHeChuHo" name="quanHeVoiChuHo" required>
                                        <option value="">-- Chọn --</option>
                                        <option value="Chủ hộ">Chủ hộ</option>
                                        <option value="Vợ/Chồng">Vợ/Chồng</option>
                                        <option value="Con">Con</option>
                                        <option value="Cha/Mẹ">Cha/Mẹ</option>
                                        <option value="Anh/Chị/Em">Anh/Chị/Em</option>
                                        <option value="Khác">Khác</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="residentTinhTrang">Tình trạng cư trú <span class="text-danger">*</span></label>
                                    <select class="form-control" id="residentTinhTrang" name="tinhTrang" required>
                                        <option value="CuTru">Thường trú</option>
                                        <option value="TamTru">Tạm trú</option>
                                        <option value="TamVang">Tạm vắng</option>
                                        <option value="ChuyenDi">Chuyển đi</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Hủy</button>
                        <button type="submit" class="btn btn-primary" id="btnSaveResident">Lưu</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="modal fade" id="logoutModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel"
        aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="exampleModalLabel">Bạn muốn đăng xuất?</h5>
                    <button class="close" type="button" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">×</span>
                    </button>
                </div>
                <div class="modal-body">Chọn "Đăng xuất" bên dưới nếu bạn muốn kết thúc phiên làm việc.</div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" type="button" data-dismiss="modal">Hủy</button>
                    <a class="btn btn-primary" href="login.html">Đăng xuất</a>
                </div>
            </div>
        </div>
    </div>

    <!-- Thay thế script local bằng CDN -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-easing/1.4.1/jquery.easing.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/startbootstrap-sb-admin-2@4.1.4/js/sb-admin-2.min.js"></script>
    <script src="https://cdn.datatables.net/1.10.24/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.10.24/js/dataTables.bootstrap4.min.js"></script>
    <script src="js/api.js"></script>

    <script>
        let dataTable;
        let editingResidentId = null;

        $(document).ready(async function() {
            await loadHouseholds();
            await loadResidents();
            
            // Wire up Add button
            $('#btnAddResident').on('click', function() {
                editingResidentId = null;
                $('#residentModalLabel').text('Thêm Cư dân');
                $('#residentForm')[0].reset();
                $('#residentId').val('');
            });
            
            // Wire up form submission
            $('#residentForm').on('submit', async function(e) {
                e.preventDefault();
                await saveResident();
            });
            
            // Reset modal on close
            $('#residentModal').on('hidden.bs.modal', function() {
                editingResidentId = null;
                $('#residentForm')[0].reset();
            });
            
            // Event delegation for DataTables buttons
            $(document).on('click', '.btn-view-resident', async function() {
                const id = $(this).data('id');
                if (id) await viewResident(id);
            });
            
            $(document).on('click', '.btn-edit-resident', async function() {
                const id = $(this).data('id');
                if (id) await editResident(id);
            });
            
            $(document).on('click', '.btn-delete-resident', async function() {
                const id = $(this).data('id');
                if (id) await deleteResident(id);
            });
            
            $(document).on('click', '.btn-return-resident', async function() {
                const id = $(this).data('id');
                if (id) await returnResident(id);
            });
        });

        async function loadHouseholds() {
            try {
                const households = await HoGiaDinhAPI.getAll();
                const select = $('#residentMaHo');
                select.empty();
                select.append('<option value="">-- Chọn hộ gia đình --</option>');
                households.forEach(h => {
                    const label = h.id ? `Hộ ${h.id}${h.soPhong ? ' - Phòng ' + h.soPhong : ''}` : `Hộ ${h.id}`;
                    select.append(`<option value="${h.id}">${label}</option>`);
                });
            } catch (error) {
                console.error('Error loading households:', error);
            }
        }

        /**
         * Build table rows from residents data
         * @param {Array} residents - Array of resident objects
         * @param {Object} householdMap - Map of household id to household object
         * @returns {Array} Array of row data arrays for DataTable
         */
        function buildResidentRows(residents, householdMap) {
            return residents.map((resident, index) => {
                const household = householdMap[resident.maHo] || {};
                // Map tinhTrang to display text
                let loaiCuTru = 'Thường trú';
                if (resident.tinhTrang === 'TamTru') loaiCuTru = 'Tạm trú';
                else if (resident.tinhTrang === 'TamVang') loaiCuTru = 'Tạm vắng';
                else if (resident.tinhTrang === 'ChuyenDi') loaiCuTru = 'Chuyển đi';
                
                let badgeClass = 'badge-primary';
                if (resident.tinhTrang === 'TamTru') badgeClass = 'badge-warning';
                else if (resident.tinhTrang === 'TamVang') badgeClass = 'badge-secondary';
                else if (resident.tinhTrang === 'ChuyenDi') badgeClass = 'badge-danger';

                const residentId = resident.id || resident.maNhanKhau;
                const actionButtons = resident.tinhTrang === 'TamVang' ? 
                    `<button class="btn btn-success btn-circle btn-sm btn-return-resident" data-id="${residentId}" title="Khai báo về lại"><i class="fas fa-check"></i></button>` :
                    `<button class="btn btn-danger btn-circle btn-sm btn-delete-resident" data-id="${residentId}" title="Xóa"><i class="fas fa-trash"></i></button>`;
                
                return [
                    index + 1,
                    `<strong>${resident.maHo || ''}</strong>`,
                    resident.hoTen || '',
                    household.soPhong || resident.maHo || '',
                    resident.quanHeVoiChuHo || '',
                    resident.soCCCD || '',
                    `<span class="badge ${badgeClass}">${loaiCuTru}</span>`,
                    `<div class="text-center">
                        <button class="btn btn-info btn-circle btn-sm btn-view-resident" data-id="${residentId}" title="Xem chi tiết">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="btn btn-warning btn-circle btn-sm btn-edit-resident" data-id="${residentId}" title="Sửa">
                            <i class="fas fa-edit"></i>
                        </button>
                        ${actionButtons}
                    </div>`
                ];
            });
        }

        /**
         * Reload residents table without full page reload
         * Efficiently updates DataTable with new data
         */
        async function reloadResidentsTable() {
            try {
                // Fetch latest data
                const residents = await NhanKhauAPI.getAll();
                const households = await HoGiaDinhAPI.getAll();
                
                // Build household map
                const householdMap = {};
                households.forEach(h => {
                    householdMap[h.id] = h;
                });

                // Build rows for DataTable
                const rows = buildResidentRows(residents || [], householdMap);

                // Update DataTable
                if (dataTable) {
                    // Clear and add new rows
                    dataTable.clear();
                    if (rows.length > 0) {
                        dataTable.rows.add(rows);
                    }
                    dataTable.draw(false); // false = don't reset paging
                } else {
                    // First time initialization
                    const tbody = $('#residentsTableBody');
                    tbody.empty();
                    
                    if (rows.length === 0) {
                        tbody.html('<tr><td colspan="8" class="text-center">Chưa có dữ liệu cư dân</td></tr>');
                        return;
                    }

                    // Initialize DataTable with data
                    dataTable = $('#dataTable').DataTable({
                        "data": rows,
                        "language": {
                            "sProcessing":   "Đang xử lý...",
                            "sLengthMenu":   "Xem _MENU_ mục",
                            "sZeroRecords":  "Không tìm thấy dòng nào phù hợp",
                            "sInfo":         "Đang xem _START_ đến _END_ trong tổng số _TOTAL_ mục",
                            "sInfoEmpty":    "Đang xem 0 đến 0 trong tổng số 0 mục",
                            "sInfoFiltered": "(được lọc từ _MAX_ mục)",
                            "sInfoPostFix":  "",
                            "sSearch":       "Tìm kiếm (Tên/Phòng/Hộ khẩu):",
                            "sUrl":          "",
                            "oPaginate": {
                                "sFirst":    "Đầu",
                                "sPrevious": "Trước",
                                "sNext":     "Tiếp",
                                "sLast":     "Cuối"
                            }
                        }
                    });
                }
            } catch (error) {
                console.error('Error reloading residents table:', error);
                APIUtils.showError('Không thể tải danh sách cư dân: ' + error.message);
            }
        }

        /**
         * Initial load of residents (first page load)
         */
        async function loadResidents() {
            await reloadResidentsTable();
        }

        async function saveResident() {
            const form = $('#residentForm')[0];
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            const btnSave = $('#btnSaveResident');
            btnSave.prop('disabled', true).text('Đang lưu...');

            try {
                // Lấy giá trị form an toàn - kiểm tra element tồn tại
                const maHoEl = $('#residentMaHo');
                const hoTenEl = $('#residentHoTen');
                const ngaySinhEl = $('#residentNgaySinh');
                const gioiTinhEl = $('#residentGioiTinh');
                const soCCCDEl = $('#residentSoCCCD');
                const ngheNghiepEl = $('#residentNgheNghiep');
                const quanHeVoiChuHoEl = $('#residentQuanHeChuHo');
                const tinhTrangEl = $('#residentTinhTrang');

                const maHoVal = maHoEl.length > 0 ? maHoEl.val() : '';
                const maHo = maHoVal ? parseInt(maHoVal) : null;
                if (!maHo || isNaN(maHo)) {
                    APIUtils.showError('Vui lòng chọn hộ gia đình');
                    return;
                }

                const residentData = {
                    maHo: maHo,
                    hoTen: hoTenEl.length > 0 ? (hoTenEl.val() || '').trim() : '',
                    ngaySinh: ngaySinhEl.length > 0 ? (ngaySinhEl.val() || '') : '',
                    gioiTinh: gioiTinhEl.length > 0 ? (gioiTinhEl.val() || '') : '',
                    soCCCD: soCCCDEl.length > 0 ? (soCCCDEl.val() || '').trim() || null : null,
                    ngheNghiep: ngheNghiepEl.length > 0 ? (ngheNghiepEl.val() || '').trim() || null : null,
                    quanHeVoiChuHo: quanHeVoiChuHoEl.length > 0 ? (quanHeVoiChuHoEl.val() || '') : '',
                    tinhTrang: tinhTrangEl.length > 0 ? (tinhTrangEl.val() || 'CuTru') : 'CuTru'
                };

                // Validate dữ liệu bắt buộc
                if (!residentData.hoTen || residentData.hoTen.length === 0) {
                    APIUtils.showError('Vui lòng nhập họ tên');
                    return;
                }
                if (!residentData.ngaySinh || residentData.ngaySinh.length === 0) {
                    APIUtils.showError('Vui lòng nhập ngày sinh');
                    return;
                }
                if (!residentData.gioiTinh || residentData.gioiTinh.length === 0) {
                    APIUtils.showError('Vui lòng chọn giới tính');
                    return;
                }

                // Log payload để debug
                console.log('[saveResident] Payload gửi lên backend:', JSON.stringify(residentData, null, 2));

                if (editingResidentId) {
                    // Update
                    await NhanKhauAPI.update(editingResidentId, residentData);
                    APIUtils.showSuccess('Cập nhật cư dân thành công');
                } else {
                    // Create
                    await NhanKhauAPI.create(residentData);
                    APIUtils.showSuccess('Thêm cư dân thành công');
                }

                $('#residentModal').modal('hide');
                await reloadResidentsTable();
            } catch (error) {
                APIUtils.showError(error.message);
            } finally {
                btnSave.prop('disabled', false).text('Lưu');
            }
        }

        async function viewResident(id) {
            try {
                if (!APIUtils.validateId(id, 'cư dân')) return;
                const resident = await NhanKhauAPI.getById(id);
                let loaiCuTru = 'Thường trú';
                if (resident.tinhTrang === 'TamTru') loaiCuTru = 'Tạm trú';
                else if (resident.tinhTrang === 'TamVang') loaiCuTru = 'Tạm vắng';
                else if (resident.tinhTrang === 'ChuyenDi') loaiCuTru = 'Chuyển đi';
                
                const ngaySinhDisplay = resident.ngaySinh ? APIUtils.formatDate(resident.ngaySinh) : 'N/A';
                alert(`Thông tin cư dân:\n\nHọ tên: ${resident.hoTen || 'N/A'}\nSố CCCD: ${resident.soCCCD || 'N/A'}\nNgày sinh: ${ngaySinhDisplay}\nGiới tính: ${resident.gioiTinh || 'N/A'}\nNghề nghiệp: ${resident.ngheNghiep || 'N/A'}\nQuan hệ chủ hộ: ${resident.quanHeVoiChuHo || 'N/A'}\nTình trạng: ${loaiCuTru}`);
            } catch (error) {
                APIUtils.showError(error.message);
            }
        }

        async function editResident(id) {
            try {
                if (!APIUtils.validateId(id, 'cư dân')) return;
                editingResidentId = id;
                const resident = await NhanKhauAPI.getById(id);
                
                // Populate form
                $('#residentModalLabel').text('Sửa Cư dân');
                $('#residentId').val(resident.id || id);
                $('#residentMaHo').val(resident.maHo || '');
                $('#residentHoTen').val(resident.hoTen || '');
                // Use normalizeDate to safely convert any date format to yyyy-MM-dd
                // Handle all possible formats: string, Date object, object with year/month/day, null
                const normalizedDate = APIUtils.normalizeDate(resident.ngaySinh);
                $('#residentNgaySinh').val(normalizedDate);
                $('#residentGioiTinh').val(resident.gioiTinh || '');
                $('#residentSoCCCD').val(resident.soCCCD || '');
                $('#residentNgheNghiep').val(resident.ngheNghiep || '');
                $('#residentQuanHeChuHo').val(resident.quanHeVoiChuHo || '');
                $('#residentTinhTrang').val(resident.tinhTrang || 'CuTru');
                
                // Show modal
                $('#residentModal').modal('show');
            } catch (error) {
                APIUtils.showError(error.message);
            }
        }

        async function returnResident(id) {
            if (!confirm('Xác nhận khai báo cư dân về lại?')) {
                return;
            }
            try {
                if (!APIUtils.validateId(id, 'cư dân')) return;
                await NhanKhauAPI.updateStatus(id, 'CuTru', {
                    ngayThayDoi: new Date().toISOString().split('T')[0],
                    lyDo: 'Khai báo về lại'
                });
                APIUtils.showSuccess('Cập nhật trạng thái thành công');
                await reloadResidentsTable();
            } catch (error) {
                APIUtils.showError(error.message);
            }
        }

        async function deleteResident(id) {
            if (!confirm('Bạn có chắc chắn muốn xóa cư dân này?')) {
                return;
            }
            try {
                if (!APIUtils.validateId(id, 'cư dân')) return;
                await NhanKhauAPI.delete(id);
                APIUtils.showSuccess('Xóa cư dân thành công');
                await reloadResidentsTable();
            } catch (error) {
                APIUtils.showError(error.message);
            }
        }
    </script>

</body>
</html>