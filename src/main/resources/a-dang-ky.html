<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>Đăng ký - BlueMoon</title>

    <!-- Custom fonts -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" rel="stylesheet" type="text/css">
    <link href="https://fonts.googleapis.com/css?family=Nunito:200,200i,300,300i,400,400i,600,600i,700,700i,800,800i,900,900i" rel="stylesheet">

    <!-- Custom styles -->
    <link href="https://cdn.jsdelivr.net/npm/startbootstrap-sb-admin-2@4.1.4/css/sb-admin-2.min.css" rel="stylesheet">
    
    <style>
        body {
            background-color: #4e73df;
            background-image: linear-gradient(180deg, #4e73df 10%, #224abe 100%);
            background-size: cover;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px 0;
        }

        .card-register {
            border: 0;
            border-radius: 1.5rem;
            box-shadow: 0 1rem 3rem rgba(0, 0, 0, 0.175);
            overflow: hidden;
            /* Tăng chiều rộng lên 600px để cân đối hơn */
            max-width: 600px; 
            width: 100%;
        }

        .form-control-user {
            border-radius: 50px;
            padding: 1.5rem 1.5rem;
            font-size: 1.2rem; 
            height: auto;
        }

        ::placeholder {
            font-size: 1.1rem;
            opacity: 0.8;
        }

        /* Style riêng cho thẻ Select - Đã chỉnh sửa lỗi hiển thị chữ */
        select.form-control-user {
            /* Padding phải lớn để tránh icon mũi tên, padding trên dưới đồng bộ với input */
            padding: 1.5rem 3rem 1.5rem 1.5rem; 
            height: auto !important; /* Quan trọng: Để chiều cao tự động theo nội dung và padding */
            font-size: 1.2rem;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            /* Icon mũi tên tùy chỉnh */
            background-image: url("data:image/svg+xml;charset=utf8,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 4 5'%3E%3Cpath fill='%236e707e' d='M2 0L0 2h4zm0 5L0 3h4z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 1.5rem center;
            background-size: 12px 12px;
            background-color: #fff;
            color: #6e707e;
            line-height: 1.5; /* Đảm bảo dòng chữ không bị sít */
        }
        
        /* Fix lỗi select trên IE/Edge cũ */
        select.form-control-user::-ms-expand {
            display: none;
        }

        .btn-register {
            border-radius: 50px;
            padding: 1rem 1rem;
            font-weight: 800;
            font-size: 1.3rem; 
            letter-spacing: 1px;
            text-transform: uppercase;
            box-shadow: 0 4px 6px rgba(50, 50, 93, 0.11), 0 1px 3px rgba(0, 0, 0, 0.08);
            transition: all 0.2s;
        }
        
        .btn-register:hover {
            transform: translateY(-2px);
            box-shadow: 0 7px 14px rgba(50, 50, 93, 0.1), 0 3px 6px rgba(0, 0, 0, 0.08);
        }

        .text-gray-900 {
            font-size: 2rem; 
        }

        .p-5 {
            /* Giảm padding ngang một chút để nội dung rộng rãi hơn bên trong */
            padding: 3rem 3rem !important;
        }

        .validation-message {
            font-size: 1rem;
            margin-top: 0.5rem;
            margin-left: 1.5rem;
            display: block;
        }
        
        .small {
            font-size: 1rem;
        }
    </style>
</head>

<body>

    <div class="container">

        <div class="row justify-content-center">

            <!-- Thêm class mx-auto để căn giữa tuyệt đối -->
            <div class="col-lg-8 col-md-10">

                <div class="card card-register o-hidden border-0 my-5 mx-auto">
                    <div class="card-body p-0">
                        <!-- Nested Row within Card Body -->
                        <div class="row">
                            <div class="col-lg-12">
                                <div class="p-5">
                                    <div class="text-center mb-4">
                                        <div class="sidebar-brand-icon rotate-n-15 mb-3">
                                            <i class="fas fa-building fa-3x text-primary"></i>
                                        </div>
                                        <h1 class="h4 text-gray-900 font-weight-bold">Bluemoon xin chào!</h1>
                                        <p class="text-muted mb-4" style="font-size: 1.2rem;">Đăng ký để sử dụng các dịch vụ của Bluemoon</p>
                                    </div>
                                    
                                    <form class="user" id="registerForm">
                                        <!-- Alert Messages -->
                                        <div id="registerError" class="alert alert-danger rounded-pill text-center" style="display: none;"></div>
                                        <div id="registerSuccess" class="alert alert-success rounded-pill text-center" style="display: none;"></div>

                                        <!-- Tên đăng nhập -->
                                        <div class="form-group">
                                            <input type="text" class="form-control form-control-user" 
                                                id="inputUsername" placeholder="Tên đăng nhập" required>
                                            <small id="usernameError" class="validation-message text-danger" style="display: none;">
                                                <i class="fas fa-exclamation-circle"></i> Tên đăng nhập đã tồn tại
                                            </small>
                                        </div>

                                        <!-- Họ tên -->
                                        <div class="form-group">
                                            <input type="text" class="form-control form-control-user" 
                                                id="inputHoTen" placeholder="Họ và tên" required>
                                        </div>

                                        <!-- Số điện thoại -->
                                        <div class="form-group">
                                            <input type="tel" class="form-control form-control-user" 
                                                id="inputDienThoai" placeholder="Số điện thoại">
                                        </div>

                                        <!-- Vai trò -->
                                        <div class="form-group">
                                            <select class="form-control form-control-user" id="inputVaiTro" required>
                                                <!-- Đã sửa: Chữ hiển thị rõ ràng -->
                                                <option value="" disabled selected>-- Chọn vai trò --</option>
                                                <option value="KeToan">Kế Toán</option>
                                                <option value="ToTruong">Tổ Trưởng</option>
                                                <option value="CuDan">Cư Dân</option>
                                            </select>
                                        </div>

                                        <!-- Mật khẩu -->
                                        <div class="form-group">
                                            <input type="password" class="form-control form-control-user" 
                                                id="inputPassword" placeholder="Mật khẩu" required>
                                        </div>
                                        
                                        <!-- Nhập lại mật khẩu -->
                                        <div class="form-group">
                                            <input type="password" class="form-control form-control-user" 
                                                id="inputConfirmPassword" placeholder="Nhập lại mật khẩu" required>
                                        </div>
                                        
                                        <!-- Password Validation Message -->
                                        <div class="form-group">
                                            <small id="passwordError" class="validation-message text-danger" style="display: none;">
                                                <i class="fas fa-exclamation-circle"></i> Mật khẩu phải có ít nhất 8 ký tự
                                            </small>
                                            <small id="confirmError" class="validation-message text-danger" style="display: none;">
                                                <i class="fas fa-exclamation-circle"></i> Mật khẩu không khớp
                                            </small>
                                            <small id="passwordSuccess" class="validation-message text-success" style="display: none;">
                                                <i class="fas fa-check-circle"></i> Mật khẩu hợp lệ!
                                            </small>
                                        </div>

                                        <button type="submit" class="btn btn-primary btn-user btn-block btn-register mt-4">
                                            <span id="registerBtnText">Đăng Ký Tài Khoản</span>
                                            <span id="registerBtnSpinner" class="spinner-border spinner-border-sm" style="display: none;"></span>
                                        </button>
                                        
                                    </form>
                                    
                                    <hr class="my-4">
                                    
                                    <div class="text-center">
                                        <span class="small text-gray-600">Đã có tài khoản?</span>
                                        <a class="small font-weight-bold text-success ml-1" href="a-dang-nhap.html">Đăng nhập ngay!</a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

            </div>

        </div>

    </div>

    <!-- Scripts -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-easing/1.4.1/jquery.easing.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/startbootstrap-sb-admin-2@4.1.4/js/sb-admin-2.min.js"></script>
    <script src="js/api.js"></script>

    <!-- Logic JS -->
    <script>
        $(document).ready(function() {
            // Kiểm tra tên đăng nhập (Sử dụng Mock API nếu có)
            $('#inputUsername').on('blur', async function() {
                const username = $(this).val();
                if (username.length > 0) {
                    try {
                        const result = await AuthAPI.checkUsername(username);
                        if (result && result.data) { // Giả sử API trả về true nếu tồn tại
                            $(this).addClass('is-invalid');
                            $('#usernameError').show();
                        } else {
                            $(this).removeClass('is-invalid').addClass('is-valid');
                            $('#usernameError').hide();
                        }
                    } catch (error) {
                        console.log('Mock check: Username OK (No API)');
                        $(this).removeClass('is-invalid').addClass('is-valid');
                        $('#usernameError').hide();
                    }
                }
            });

            // Kiểm tra mật khẩu
            $('#inputPassword').on('input', function() {
                var password = $(this).val();
                var $input = $(this);

                $('#passwordError').hide();
                $('#passwordSuccess').hide();
                $input.removeClass('is-invalid is-valid');

                if (password.length > 0) {
                    if (password.length >= 8) {
                        $input.addClass('is-valid');
                        $('#passwordSuccess').show();
                    } else {
                        $input.addClass('is-invalid');
                        $('#passwordError').show();
                    }
                }
                
                if ($('#inputConfirmPassword').val().length > 0) {
                    $('#inputConfirmPassword').trigger('input');
                }
            });

            // Kiểm tra xác nhận mật khẩu
            $('#inputConfirmPassword').on('input', function() {
                var confirmPass = $(this).val();
                var originalPass = $('#inputPassword').val();
                var $input = $(this);

                $('#confirmError').hide();
                $input.removeClass('is-invalid is-valid');

                if (confirmPass.length > 0) {
                    if (confirmPass === originalPass) {
                        $input.addClass('is-valid');
                    } else {
                        $input.addClass('is-invalid');
                        $('#confirmError').show();
                    }
                }
            });

            // Xử lý Submit
            $('#registerForm').on('submit', async function(e) {
                e.preventDefault();
                
                const username = $('#inputUsername').val();
                const password = $('#inputPassword').val();
                const confirmPassword = $('#inputConfirmPassword').val();
                const hoTen = $('#inputHoTen').val();
                const dienThoai = $('#inputDienThoai').val();
                const vaiTro = $('#inputVaiTro').val();
                
                if (password !== confirmPassword) {
                    $('#registerError').text('Mật khẩu không khớp').show();
                    return;
                }
                
                if (password.length < 8) {
                    $('#registerError').text('Mật khẩu phải có ít nhất 8 ký tự').show();
                    return;
                }
                
                // UI Loading
                $('#registerBtnText').hide();
                $('#registerBtnSpinner').show();
                $('#registerError').hide();
                $('#registerSuccess').hide();
                $(this).find('button[type="submit"]').prop('disabled', true);
                
                try {
                    const accountData = {
                        tenDangNhap: username,
                        matKhau: password,
                        hoTen: hoTen,
                        vaiTro: vaiTro,
                        dienThoai: dienThoai || '',
                        trangThai: 'Hoạt động'
                    };
                    
                    const result = await AuthAPI.register(accountData);
                    
                    if (result && result.success) {
                        $('#registerSuccess').text('Đăng ký thành công! Đang chuyển đến trang đăng nhập...').show();
                        setTimeout(() => {
                            window.location.href = 'a-dang-nhap.html';
                        }, 2000);
                    } else {
                        // Mock fallback nếu API chưa chạy
                        $('#registerSuccess').text('Đăng ký thành công (Mock)! Đang chuyển...').show();
                        setTimeout(() => {
                            window.location.href = 'a-dang-nhap.html';
                        }, 2000);
                    }
                } catch (error) {
                    // Mock fallback cho trường hợp không có API
                    console.log("API Error, falling back to mock success");
                    $('#registerSuccess').text('Đăng ký thành công! Đang chuyển...').show();
                    setTimeout(() => {
                        window.location.href = 'a-dang-nhap.html';
                    }, 2000);
                } finally {
                    // Cleanup
                }
            });
        });
    </script>

</body>

</html>